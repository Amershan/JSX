<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>JSX - Profile Results</title>
    <meta name="robots" content="noindex,nofollow">
    <link rel="shortcut icon" href="assets/favicon.ico">

    <link href="assets/css/jquery.treeTable.css" rel="stylesheet" type="text/css">
<style type="text/css">
body {
  margin: 0;
  padding: 0;
}
#controller {
  padding: 1em 0.5em;
  Background: #ddd;
  font-weight: bold;
}
#results {
  width: 100%;
  border-collapse: collapse;
  border: white solid 1px;
}
#results th {
  background: #ddd;
  border: white solid 1px;
  white-space: nowrap;
  padding: 0.2em 1em;
}
#results th a {
  color: black;
  display: block;
  text-decoration: none;
}
#results td {
  border-width: 0 0 1px 0;
  border-color: #ddd;
  border-style: solid;
  padding: 0.2em 0.2em;
}
#results .symbol {
  text-overflow: hidden;
  overflow: hidden;
  padding-left: 2em;
}
#results .number {
  border-width: 0 0 1px 1px;
  text-align: right;
  vertical-align: top;
}
</style>

    <script type="text/javascript" src="assets/js/jquery.js"></script>
    <script type="text/javascript" src="assets/js/jquery.treeTable.js"></script>
    <script type="text/javascript">

var profileData = function () {
  var id = location.search.substring(1);
  if (! id)
    return;
  var xhr = new XMLHttpRequest();
  xhr.open("GET", ".profile/" + id + ".txt", false);
  xhr.send(null);
  if (xhr.status != 200) {
    alert("failed to load profile data from server");
    return;
  }
  return JSON.parse(xhr.responseText);
}();

var functions = function () {
  var map = {};
  (function doit(name, entry) {
    for (var k in entry) {
      if (k.charAt(0) != "$") {
        doit(k, entry[k]);
      }
    }
    if (name) {
      if (map[name]) {
        map[name].count += entry.$count;
        map[name].inclusive += entry.$inclusive;
        map[name].exclusive += entry.$exclusive;
      } else {
        map[name] = {
          count:     entry.$count,
          inclusive: entry.$inclusive,
          exclusive: entry.$exclusive
        };
      }
    }
  })(null, profileData);
  var ret = [];
  for (var k in map) {
    if (map[k].count != 0) {
      ret.push({
        name:      k,
        count:     map[k].count,
        inclusive: map[k].inclusive,
        exclusive: map[k].exclusive
      });
    }
  }
  return ret;
}();

var tree = function doit(list, entry) {
  list.push({
    name:      entry.$name,
    count:     entry.$count,
    inclusive: entry.$inclusive,
    exclusive: entry.$exclusive
  });
  var callee = [];
  for (var k in entry) {
    if (k.charAt(0) != "$") {
      doit(callee, entry[k]);
    }
  }
  list[list.length - 1].callee = callee.sort(function (x, y) {
    return x.inclusive - y.inclusive;
  });
  return list;
}([], profileData);

function escapeHTML(s) {
  return s.toString()
    .replace(/&/g, "&amp;")
    .replace(/\u0022/g, "&quot;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;");
}

function insertDecimalSeparator(n) {
  var s = n.toString();
  while (true) {
    var s2 = s.replace(/([0-9])([0-9]{3}(?:,|\.|$))/, function (a, m1, m2) {
      return m1 + "," + m2;
    });
    if (s2 == s)
      break;
    s = s2;
  }
  return s;
}

function buildHeader() {
  var html = "<table id='results'><tr>"
    + "<th><a href='javascript:updateTable(%22name%22)'>Function</a></th>"
    + "<th><a href='javascript:updateTable(%22count%22)'>Count</a></th>"
    + "<th><a href='javascript:updateTable(%22inclusive%22)'>Inclusive (ms)</a></th>"
    + "<th><a href='javascript:updateTable(%22exclusive%22)'>Exclusive (ms)</a></th>"
    + "</tr>";
  return html;
}

function buildRow(id, parentId, name, count, inclusive, exclusive) {
    return "<tr"
     + (id != null ? " id='" + id + "'" : "")
     + (parentId != null ? " class='" + parentId + "'" : "")
     + "><td class='symbol'>" + escapeHTML(name) + "</td>"
     + "<td class='number'>" + insertDecimalSeparator(count) + "</td>"
     + "<td class='number'>" + insertDecimalSeparator(inclusive) + "</td>"
     + "<td class='number'>" + insertDecimalSeparator(exclusive) + "</td>"
     + "</tr>";
}

function buildList(comparator) {
  var list = functions.sort(comparator);
  var html = buildHeader();
  list.forEach(function (entry) {
    html += buildRow(
      null, null, entry.name, entry.count, entry.inclusive, entry.exclusive);
  });
  html += "</table>";
  $("#results-holder").html(html);
}

function buildTree(comparator) {
  var html = buildHeader();
  var rowIndex = 1;
  (function doit(callee, parentRowIndex) {
    var callee = callee.sort(comparator);
    for (var i = 0; i < callee.length; ++i) {
      var theRowIndex = rowIndex++;
      html += buildRow(
        "node-" + theRowIndex,
        parentRowIndex ? "child-of-node-" + parentRowIndex : null,
        callee[i].name, callee[i].count, callee[i].inclusive,
        callee[i].exclusive);
      doit(callee[i].callee, theRowIndex);
    }
  })(tree[0].callee, 0);
  html += "</table>";
  $("#results-holder").html(html);
  $("#results").treeTable();
}

function updateTable(orderBy) {
  switch ($("#mode option:selected").val()) {
  case "tree":
    var builder = buildTree;
    break;
  case "name":
    builder = buildList;
    break;
  default:
    throw new Error("unexpected mode");
  }
  builder(function (x, y) {
    var xValue = x[orderBy];
    var yValue = y[orderBy];
    if (xValue == yValue)
      var ret = 0;
    else if (xValue < yValue)
      ret = -1;
    else
      ret = 1;
    if (orderBy != "name")
      ret *= -1;
    return ret;
  });
}

$(document).ready(function () {
  $("#mode").bind("change", function () {
    updateTable("count");
    return true;
  });
  updateTable("count");
});

    </script>
  </head>
  <body>
    <div id="controller">
      Mode:
      <select id="mode">
	<option value="tree">Call Tree</option>
	<option value="name">Functions</option>
      </select>
    </div>
    <div id="results-holder">
    </div>
  </body>
</html>
